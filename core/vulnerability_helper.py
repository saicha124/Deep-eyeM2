"""
Vulnerability Helper
Helper functions for creating and enhancing vulnerability records
"""

from datetime import datetime
from typing import Dict, Optional
import os


def create_vulnerability(
    vuln_type: str,
    severity: str,
    url: str,
    description: str,
    evidence: str,
    remediation: str,
    **kwargs
) -> Dict:
    """
    Create a vulnerability record with timestamp and standard fields.
    
    Args:
        vuln_type: Type of vulnerability (e.g., "SQL Injection")
        severity: Severity level (critical, high, medium, low, info)
        url: Vulnerable URL
        description: Description of the vulnerability
        evidence: Evidence of the vulnerability
        remediation: How to fix the vulnerability
        **kwargs: Additional fields (parameter, payload, cwe, etc.)
    
    Returns:
        Dictionary with vulnerability data including timestamp
    """
    vulnerability = {
        'type': vuln_type,
        'severity': severity.lower(),
        'url': url,
        'description': description,
        'evidence': evidence,
        'remediation': remediation,
        'timestamp': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
    }
    
    # Add optional fields
    if 'parameter' in kwargs:
        vulnerability['parameter'] = kwargs['parameter']
    if 'payload' in kwargs:
        vulnerability['payload'] = kwargs['payload']
    if 'cwe' in kwargs:
        vulnerability['cwe'] = kwargs['cwe']
    if 'plugin' in kwargs:
        vulnerability['plugin'] = kwargs['plugin']
    
    # Add any other custom fields
    for key, value in kwargs.items():
        if key not in vulnerability:
            vulnerability[key] = value
    
    # Enhance detector info with code snippet if present
    if 'detector' in vulnerability and isinstance(vulnerability['detector'], dict):
        vulnerability['detector'] = enhance_detector_with_code(vulnerability['detector'])
    
    return vulnerability


def add_timestamp_to_vulnerability(vulnerability: Dict) -> Dict:
    """
    Add timestamp to an existing vulnerability if it doesn't have one.
    
    Args:
        vulnerability: Vulnerability dictionary
        
    Returns:
        Vulnerability dictionary with timestamp
    """
    if 'timestamp' not in vulnerability:
        vulnerability['timestamp'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    return vulnerability


def add_timestamps_to_vulnerabilities(vulnerabilities: list) -> list:
    """
    Add timestamps to a list of vulnerabilities.
    
    Args:
        vulnerabilities: List of vulnerability dictionaries
        
    Returns:
        List of vulnerabilities with timestamps
    """
    return [add_timestamp_to_vulnerability(v) for v in vulnerabilities]


def extract_code_snippet(file_path: str, line_range: str) -> Optional[str]:
    """
    Extract code snippet from a file based on line range.
    
    Args:
        file_path: Path to the source file
        line_range: Line range in format "start-end" (e.g., "803-856")
        
    Returns:
        Code snippet as string, or None if extraction fails
    """
    try:
        # Parse line range
        if '-' not in line_range:
            return None
        
        start_line, end_line = map(int, line_range.split('-'))
        
        # Check if file exists
        if not os.path.exists(file_path):
            return None
        
        # Read and extract lines
        with open(file_path, 'r', encoding='utf-8') as f:
            lines = f.readlines()
        
        # Validate line numbers
        if start_line < 1 or end_line > len(lines) or start_line > end_line:
            return None
        
        # Extract snippet (convert to 0-indexed)
        snippet_lines = lines[start_line - 1:end_line]
        
        # Limit snippet size to prevent huge code blocks
        max_lines = 50
        if len(snippet_lines) > max_lines:
            snippet_lines = snippet_lines[:max_lines]
            snippet_lines.append(f"\n... [{len(lines[start_line - 1:end_line]) - max_lines} more lines]")
        
        return ''.join(snippet_lines)
    
    except Exception:
        return None


def enhance_detector_with_code(detector: Optional[Dict]) -> Optional[Dict]:
    """
    Enhance detector information with code snippet from the detected lines.
    
    Args:
        detector: Detector information dictionary with 'file' and 'lines' keys
        
    Returns:
        Enhanced detector dictionary with 'code_snippet' added, or original if extraction fails
    """
    if not detector or not isinstance(detector, dict):
        return detector
    
    # Check if we have both file and lines
    file_path = detector.get('file')
    line_range = detector.get('lines')
    
    if not file_path or not line_range:
        return detector
    
    # Extract code snippet
    code_snippet = extract_code_snippet(file_path, line_range)
    
    if code_snippet:
        detector['code_snippet'] = code_snippet
    
    return detector
